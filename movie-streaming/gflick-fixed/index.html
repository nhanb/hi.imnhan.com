<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Streaming videos from Google Drive: a second attempt | Hi, I&#39;m Nh√¢n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="alternate" type="application/atom+xml" title="Atom feed" href="/feed.xml">
  <link rel="stylesheet" href="/_s4g/theme/base.css">

  <meta property="og:title" content="Streaming videos from Google Drive: a second attempt" />
  <meta name="twitter:title" content="Streaming videos from Google Drive: a second attempt" />
  <meta name="twitter:card" content="summary" /><meta property="og:image" content="https://hi.imnhan.com/about/keyboard-warrior.jpg" />
    <meta name="twitter:image" content="https://hi.imnhan.com/about/keyboard-warrior.jpg" /><meta name="twitter:site" content="@nhanb" />
</head>

<body>

<link rel="stylesheet" href="/_s4g/theme/navbar.css">
<nav>
  <a href="/" >Home</a>
  <a href="/about/" >About</a>
  <a href="/projects/" >Projects</a>
  <a href="https://cv.imnhan.com" target="_blank">CVü°ï</a>

  <a class="feed-link" href="/feed.xml">Atom&nbsp;Feed</a>
  <span class="posted-on">
    Posted on
    <time datetime="2020-06-10">
        Wednesday, 10 Jun 2020
    </time>
  </span>

</nav>
<hr class="nav-hr">


<main>
<em>
  This post is part of
  <a href="/movie-streaming/">The movie streaming saga</a>
</em>
<hr>

<h1>Streaming videos from Google Drive: a second attempt</h1>

<p><strong>TL;DR:</strong> I improved the Google Drive video streaming experience mentioned in
an <a href="/posts/towards-an-acceptable-video-playing-experience/">earlier blog post</a>. It now works like this on an Android phone with
mpv-android installed:</p>
<video controls>
  <source src="https://junk.imnhan.com/gflick-phone-demo.mp4" type="video/mp4">
  <a href="https://junk.imnhan.com/gflick-phone-demo.mp4">
    Video: https://junk.imnhan.com/gflick-phone-demo.mp4
  </a>
</video>
<p>The longer version follows.</p>
<p><a href="/posts/towards-an-acceptable-video-playing-experience/">Previously</a> I was writing a proxy of sorts that adapted Google Drive‚Äôs
‚Äúbearer token‚Äù auth to the more widely supported ‚Äúbasic auth‚Äù so I could watch
movies. I was stuck at the point where desktop video players could stream just
fine while their android ports would do nothing.</p>
<p>Turns out it was a TLS issue: I configured nginx to use TLSv1.3 which is the
latest and greatest, but mpv/vlc on android came bundled with older TLS
libraries which only supported up to v1.2. This led me to another surprise: the
nginx config generated by <a href="https://ssl-config.mozilla.org/#server=nginx&amp;version=1.17.7&amp;config=intermediate&amp;openssl=1.1.1d&amp;guideline=5.4">Mozilla‚Äôs SSL Configuration Generator</a>, while
advertised to support older TLSes (in either <code>Intermediate</code> or <code>Old</code> mode),
didn‚Äôt actually work in practice. <a href="https://www.ssllabs.com/ssltest/">SSL tests</a> always reported that the only
working SSL/TLS protocol was TLSv1.3.</p>
<div class="sidenote">
<p>I pinpointed this issue from reading the android device‚Äôs logcat output.
Did you know that in order to read logcat you only need to install
some <a href="https://pkgs.org/search/?q=android-tools">8MiB package</a> instead of the whole Android Studio behemoth? I
do now!</p>
</div>
<p>As luck would have it, <a href="https://caddyserver.com/v2">Caddy v2</a> was recently released and they even
provided a Debian repo! I had used Caddy v1 in the past but my impression was
that despite their pitch of a ‚Äúdownload and run‚Äù experience, actual <a href="https://github.com/caddyserver/caddy/tree/v1.0.4/dist/init/linux-systemd">extra
work</a> was required - it was straightforward and well-documented, but it was
still extra busywork. This combined with the hassle of having to compile my own
binary bounced me back to nginx. Both of these issues have been addressed in
v2, so there‚Äôs really no reason to keep wrestling with nginx + certbot anymore.</p>
<div class="sidenote">
<p>On that note, to this day I still haven‚Äôt figured out how to make the
nginx/certbot combo play nice with ansible. Problem is, certbot‚Äôs nginx
plugin wants to mutate the nginx config file itself, so the nginx configs
before vs after certbot runs are decidedly different. This requires
ridiculous gymnastics to mold into an ansible play - and don‚Äôt even get me
started on multi-site setups. A <a href="https://github.com/nhanb/gflick/blob/4dd3dbdbdfe8de66337ed0a2fe420dd0e1d72f39/caddy/gflick">Caddyfile</a>, on the other hand, simply
gets out of your way.</p>
</div>
<p>Now that TLS is settled, I also made some changes to the usage flow:</p>
<section id="Authentication">
<h3>Authentication</h3>
<p>The authentication responsibility has been moved from nginx/caddy to the python
application itself to enable more fine-grained control:</p>
<p>Every route, except for the video-serving <code>/v/*</code>, requires a <code>user_token</code> cookie.
If it doesn‚Äôt exist, redirect to <code>/login</code>, which will let user submit a
password in order to get the user token back. User token is a 128-byte string
that‚Äôs regenerated every time the python script restarts. I should probably
write a janitor script to periodically regenerate it instead.</p>
<p>When user navigates to a video, a unique 128-byte slug is generated just for it
and the video can now be directly streamed at <code>/v/&lt;slug&gt;</code>, with no
authentication required. Currently slugs older than 1 day are wiped on python
application startup, but then, like user token, I should probably stop relying
on the script restarting to do cleanup operations.</p>
<p>With this setup I can freely share the <code>/v/&lt;slug&gt;</code> url to other people without
leaking any auth credentials, and they eventually expire too. There‚Äôs tuning to
be done for expiration mechanisms but the foundations are there.</p>
</section>
<section id="Aesthetics">
<h3>Aesthetics</h3>
<p>The web interface has been revamped to make it easier for <del>fat-fingered
people on $current_year‚Äôs trendy stupidly thin</del> phones. Also present
are folder icons and thumbnails, so it finally gives me everything I want from
Google Drive‚Äôs web UI and nothing that I don‚Äôt. Fun fact: it works on
<a href="https://www.netsurf-browser.org/">NetSurf</a> too (but then again why wouldn‚Äôt it?).</p>
<p><img alt="gflick screenshot" src="gflick_01_mobile.png"></p>
</section>
<section id="What-s-the-catch">
<h2>What‚Äôs the catch?</h2>
<p><strong>Client device is solely responsible for decoding the raw file.</strong> This is both
a blessing and a curse: We are guaranteed original quality but if the file was
encoded with newer codecs (h265, av1, etc.) we‚Äôre stuck with inefficient
software decoding and some devices are just too weak to do so smoothly. My
Amazon Fire HD 10 tablet suffers greatly when playing 1080p 10bit anime.
Curiously, my crappy Mi A3 phone yields better performance, although stutters
still happen here and there. More modest h264 movies play flawlessly, for what
it‚Äôs worth.</p>
<p><strong>This is a proof of concept and the codebase quality reflects that.</strong> I‚Äôm in
the middle of cleaning it up for pypi friendliness and xdg compliance, but
currently stuck when porting from std‚Äôs http server to bottlepy. The current
dirty codebase is working fine for me so I‚Äôm in no hurry though‚Ä¶</p>
</section>
<section id="In-conclusion">
<h2>In conclusion</h2>
<p>I‚Äôm happy with how things turned out: I have <a href="https://drive.google.com/">zero-maintenance unlimited cloud
storage</a> for movies and an effortless streaming experience that requires
virtually no client-side setup - just install a browser and streaming-capable
video player, then everything works out of the box. This is <em>almost</em> as
convenient as Netflix, but without the stupid quality restriction on
non-sanctioned devices. I probably need to upgrade to a beefier tablet though.</p>
</section>


  <div class="series-container">
    <p>
      Here's every post in
      <a href="/movie-streaming/">The movie streaming saga</a>,
      in chronological order:
    </p>

    <ol>
      <li><a href="/movie-streaming/gflick/">Towards an acceptable video playing experience</a></li>
      <li><a href="/movie-streaming/gflick-fixed/">Streaming videos from Google Drive: a second attempt</a> (you are here)</li>
      <li><a href="/movie-streaming/put.io/">The video streaming finale, or why put.io is awesome</a></li>
    </ol>
  </div>

  <style>
    .series-container {
      margin: 2rem 0;
      padding: 0 1rem;
      border: 1px dashed #aaa;
      background-color: #eee;
    }
  </style>
</main>

<footer>
¬© 2013‚Äì2023 B√πi Th√†nh Nh√¢n<br>
Made with <a href="https://github.com/nhanb/s4g">s4g</a> and probably too much <a href="https://www.instagram.com/cheese.coffee/">c√† ph√™ s·ªØa ƒë√°</a>
</footer>

</body>

</html>
